pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
-- coroutine action

actors = {}
player = nil

function _init()
	player = actor({
		k=1, w=2, h=2,
		x=10, y=50
	})
end


function _update()
	player_input()

	for ÏõÉ in all(actors) do
		if ÏõÉ.action 
		 and costatus(ÏõÉ.action) != "dead" then
			assert(coresume(ÏõÉ.action, ÏõÉ))
	 end
	end
end

function _draw()
	cls(13)
	
	for ÏõÉ in all(actors) do
		spr(ÏõÉ.k, 
			ÏõÉ.x, ÏõÉ.y, 
			ÏõÉ.w, ÏõÉ.h, 
			ÏõÉ.dir == -1, 
			ÏõÉ.flip_y)
			
		if ÏõÉ.debug then
			print(ÏõÉ.debug)
		end
	end
end
-->8
-- actors!


-- actor has sprite and position.
function actor(config)
 local ÏõÉ = {
  -- sprite props
 	x=0, -- pos x
 	y=0, -- pos y
 	k=0, -- sprite number
 	w=1, -- sprites wide
 	h=1, -- sprites tall
 	flip_y=false,
 	-- physics
 	acc=0, -- acceration
 	dir=1, -- direction
 	-- state props
 	action=nil,
 	next_action=nil,
 	can_interrupt=true,
 }
 -- merge the config in, overriding default values.
 merge(ÏõÉ, config)
 -- start the action
 start_action(ÏõÉ, ÏõÉ.action)
 -- add to the list
 add(actors, ÏõÉ)
 return ÏõÉ
end


-->8
-- utils
--[[
‚Ä¶‚àß‚ñë‚û°Ô∏è‚ßó‚ñ§‚¨ÜÔ∏è‚òâüÖæÔ∏è‚óÜ{}
‚ñà‚òÖ‚¨áÔ∏è‚úΩ‚óè‚ô•ÏõÉ‚åÇ‚¨ÖÔ∏è
‚ñ•‚ùéüê±Àá‚ñí‚ô™üòê
]]--


function start_action(ÏõÉ, action)
	if not action then return end
	-- skip if the current action can't be inturrupted.
	if ÏõÉ.action and not ÏõÉ.can_interrupt then return end
	-- don't restart the action if it's running.
	if ÏõÉ.action_‚òâ == action 
	 and costatus(ÏõÉ.action) != "dead" then return end
	-- start the action as coroutine
	ÏõÉ.action = cocreate(action)	
end


-- merges obj2 into obj1
function merge(‚òÖ, üê±)
	for k,v in pairs(üê±) do
		‚òÖ[k] = v
	end
	return ‚òÖ
end
-->8
-- coroutine actions

function idle(obj)
	while true do
		obj.x -= 4
		yield()
		obj.x += 4
		yield()
		obj.x += 4
		yield()
		obj.x -= 4
	end
end

function walk(ÏõÉ)
	ÏõÉ.can_interrupt = true
	
	while ÏõÉ.acc > 0 do
		ÏõÉ.x += ÏõÉ.dir * ÏõÉ.acc
		yield()
	end
end

function jump(ÏõÉ)
	ÏõÉ.can_interrupt = false
	
	while ÏõÉ.y > 0 
	 and ÏõÉ.y < 128 do
		ÏõÉ.y -= ÏõÉ.acc
		-- add gravity
		ÏõÉ.y *= 0.95
		yield()
	end
	
	ÏõÉ.can_interrupt = true
end
-->8
function player_input()
	local ÏõÉ = player
	
	if btn(‚û°Ô∏è) then
		--ÏõÉ.x += 8
		ÏõÉ.dir = 1
		ÏõÉ.acc = 1
	 start_action(ÏõÉ, walk)
	elseif btn(‚¨ÖÔ∏è) then
		ÏõÉ.dir = -1
		ÏõÉ.acc = 1
		start_action(ÏõÉ, walk)
	else
		ÏõÉ.acc = 0
	end
	
	if btn(‚¨ÜÔ∏è) then
		ÏõÉ.acc = 1
		start_action(ÏõÉ, jump)
	else
	
	end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000088800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000008800088000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000008000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000080000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000080000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000080000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000008000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000008800088000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000288800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000222444220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002244422422000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022224444222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002244404422000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000044000440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
